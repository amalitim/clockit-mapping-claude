{% extends "base.html" %}

{% block title %}Make Predictions - Task Type Classifier{% endblock %}

{% block content %}
<style>
/* Custom styles for enhanced predictions page */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: box-shadow 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.table thead th {
    border: none;
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: 0.85rem;
    padding: 1rem 0.75rem;
}

.table tbody td {
    border: none;
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid #f8f9fa;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    cursor: pointer;
}

.table tbody tr.clickable-row {
    cursor: pointer;
}

.table tbody tr.clickable-row:hover {
    background-color: #e3f2fd !important;
    border-left: 4px solid #2196f3;
}

.sortable-header:hover {
    background-color: rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 4px 8px;
    transition: all 0.2s ease;
}

.confidence-high { color: #198754 !important; font-weight: 600; }
.confidence-medium { color: #fd7e14 !important; font-weight: 600; }
.confidence-low { color: #dc3545 !important; font-weight: 600; }

.badge {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
}

.btn-outline-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.pagination .page-link {
    border: none;
    padding: 0.5rem 0.75rem;
    margin: 0 0.125rem;
    border-radius: 8px;
    color: #6c757d;
    font-weight: 500;
}

.pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
}

.pagination .page-link:hover {
    background-color: #e9ecef;
    transform: translateY(-1px);
}

.progress {
    background-color: #e9ecef;
    border-radius: 10px;
    height: 8px;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.3s ease;
}

.loading-overlay {
    backdrop-filter: blur(2px);
    background-color: rgba(255, 255, 255, 0.9) !important;
}

.input-group .form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    border-color: #86b7fe;
}

.table-dark {
    --bs-table-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.table-dark th {
    color: white !important;
    background: transparent !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
}

.form-select:focus, .form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
}

/* Animation for table rows */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.prediction-row {
    animation: fadeInUp 0.3s ease;
}

/* Confidence visualization enhancements */
.confidence-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
}
</style>
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-upload"></i> Make Predictions</h2>
        <p class="text-muted">Upload a CSV or Excel (.xlsx) file without the 'Type' column to get predictions.</p>

        <!-- File Upload Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-upload"></i> Upload File</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="file" class="form-control" id="csvFile" accept=".csv,.xlsx">
                    <div class="form-text">Select a CSV or Excel file with columns: Employees, Task Name, Category, Project, Billability Status (Source.Name column no longer required)</div>
                </div>
                <button type="button" class="btn btn-primary" id="uploadBtn" disabled>
                    <i class="fas fa-upload"></i> Upload & Analyze
                </button>
                
                <div id="uploadProgress" class="progress mt-3 d-none">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div id="uploadResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Predictions Section -->
        <div id="predictionsSection" class="d-none">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-brain"></i> Predictions</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="predictBtn" disabled>
                            <i class="fas fa-magic"></i> Generate Predictions
                        </button>
                        <button type="button" class="btn btn-sm btn-success" id="downloadBtn" disabled>
                            <i class="fas fa-download"></i> Download Results
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="fileInfo" class="mb-3"></div>
                    
                    <!-- Predictions Table -->
                    <div id="predictionsTable" class="d-none">
                        <!-- Enhanced Controls Bar -->
                        <div class="card mb-3">
                            <div class="card-body py-3">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text bg-primary text-white"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="searchInput" placeholder="Search across all fields...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="pageSizeSelect">
                                            <option value="25">25 per page</option>
                                            <option value="50" selected>50 per page</option>
                                            <option value="100">100 per page</option>
                                            <option value="250">250 per page</option>
                                            <option value="all">Show all</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="resetBtn">
                                                <i class="fas fa-undo"></i> Reset
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" id="refreshBtn">
                                                <i class="fas fa-sync-alt"></i> Refresh
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <div class="pagination-info small text-muted" id="paginationInfo">
                                            <!-- Pagination info will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Table Card -->
                        <div class="card shadow-sm">
                            <div class="table-responsive">
                                <table class="table table-hover table-striped mb-0">
                                    <thead class="table-dark">
                                        <tr id="tableHeaders">
                                            <!-- Headers will be populated dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- Predictions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Loading Overlay -->
                            <div id="loadingOverlay" class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2 text-muted">Processing data...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Pagination -->
                        <div class="row mt-3 align-items-center">
                            <div class="col-md-6">
                                <nav id="paginationNav">
                                    <ul class="pagination pagination-sm mb-0" id="paginationList">
                                        <!-- Pagination will be populated here -->
                                    </ul>
                                </nav>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex justify-content-end align-items-center gap-3">
                                    <small class="text-muted" id="pageInfo">
                                        <!-- Page info will be populated here -->
                                    </small>
                                    <div class="input-group" style="width: 120px;">
                                        <span class="input-group-text input-group-text-sm">Go to</span>
                                        <input type="number" class="form-control form-control-sm" id="jumpToPage" placeholder="Page" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <small class="text-muted">
                                    <span class="confidence-high">High confidence (>0.8)</span> |
                                    <span class="confidence-medium">Medium confidence (0.6-0.8)</span> |
                                    <span class="confidence-low">Low confidence (<0.6)</span>
                                </small>
                            </div>
                            <div id="predictionStats"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Prediction Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Prediction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Prediction:</label>
                    <p id="currentPrediction" class="fw-bold"></p>
                </div>
                <div class="mb-3">
                    <label for="newPrediction" class="form-label">New Type:</label>
                    <select class="form-select" id="newPrediction">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Task Details:</label>
                    <div id="taskDetails" class="small text-muted">
                        <!-- Task details will be shown here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFile = null;
let serverFilename = null;
let currentPredictions = null;
let editingRowIndex = null;
let originalPredictions = null;
let availableClasses = [];
let currentSortColumn = null;
let currentSortDirection = 'asc';
// Pagination variables
let currentPage = 1;
let pageSize = 50;
let totalPages = 1;
let filteredPredictions = [];

// File input handler
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const uploadBtn = document.getElementById('uploadBtn');
    
    if (file && (file.type === 'text/csv' || file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || file.name.endsWith('.xlsx'))) {
        uploadBtn.disabled = false;
        currentFile = file;
    } else {
        uploadBtn.disabled = true;
        currentFile = null;
        if (file) {
            alert('Please select a CSV or Excel (.xlsx) file.');
        }
    }
});

// Upload button handler
document.getElementById('uploadBtn').addEventListener('click', function() {
    if (!currentFile) return;
    
    const formData = new FormData();
    formData.append('file', currentFile);
    
    const btn = this;
    const progressDiv = document.getElementById('uploadProgress');
    const resultDiv = document.getElementById('uploadResult');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    progressDiv.classList.remove('d-none');
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> ${data.message}
                </div>
            `;
            
            // Store the server filename
            serverFilename = data.filename;
            
            // Show file info and enable prediction
            showFileInfo(data.file_info);
            document.getElementById('predictionsSection').classList.remove('d-none');
            document.getElementById('predictBtn').disabled = false;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> Error: ${error.message}
            </div>
        `;
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload"></i> Upload & Analyze';
        progressDiv.classList.add('d-none');
    });
});

// Predict button handler
document.getElementById('predictBtn').addEventListener('click', function() {
    if (!currentFile || !serverFilename) return;
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    
    fetch('/predict_file', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: serverFilename
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentPredictions = data.predictions;
            originalPredictions = [...data.predictions]; // Store original for reset
            filteredPredictions = [...data.predictions]; // Initialize filtered data
            currentPage = 1; // Reset to first page
            showPredictions(data.predictions);
            document.getElementById('downloadBtn').disabled = false;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> Generate Predictions';
    });
});

// Download button handler
document.getElementById('downloadBtn').addEventListener('click', function() {
    if (!serverFilename) return;
    
    window.location.href = '/download/predicted_claude_' + serverFilename;
});

function showFileInfo(fileInfo) {
    const infoDiv = document.getElementById('fileInfo');
    infoDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <strong>File:</strong> ${fileInfo.filename}<br>
                <strong>Rows:</strong> ${fileInfo.row_count}
            </div>
            <div class="col-md-6">
                <strong>Columns:</strong> ${fileInfo.columns.join(', ')}
            </div>
        </div>
    `;
}

function showPredictions(predictions, forceRefresh = false) {
    if (!predictions || predictions.length === 0) return;
    
    const tableDiv = document.getElementById('predictionsTable');
    const headersRow = document.getElementById('tableHeaders');
    const bodyTable = document.getElementById('tableBody');
    
    // Show loading if processing large dataset
    if (predictions.length > 200) {
        showLoading(true);
    }
    
    // Update filtered predictions if this is the source data
    if (forceRefresh || filteredPredictions.length === 0) {
        filteredPredictions = [...predictions];
    }
    
    // Calculate pagination
    totalPages = pageSize === 'all' ? 1 : Math.ceil(filteredPredictions.length / parseInt(pageSize));
    if (currentPage > totalPages) currentPage = 1;
    
    // Get paginated data
    const startIndex = pageSize === 'all' ? 0 : (currentPage - 1) * parseInt(pageSize);
    const endIndex = pageSize === 'all' ? filteredPredictions.length : startIndex + parseInt(pageSize);
    const paginatedPredictions = filteredPredictions.slice(startIndex, endIndex);
    
    // Clear existing content only if headers need to be rebuilt
    if (headersRow.children.length === 0) {
        headersRow.innerHTML = '';
    }
    bodyTable.innerHTML = '';
    
    // Get columns (excluding our added prediction columns for display)
    const sampleRow = predictions[0];
    const columns = Object.keys(sampleRow).filter(col => 
        !['Predicted_Type', 'Confidence'].includes(col)
    );
    
    // Add headers with sorting (only if not already added)
    if (headersRow.children.length === 0) {
        columns.forEach(col => {
            const th = document.createElement('th');
            th.className = 'user-select-none';
            th.innerHTML = `
                <div class="sortable-header d-flex align-items-center justify-content-between" data-column="${col}" style="cursor: pointer;">
                    <span class="fw-semibold text-white">${col}</span>
                    <i class="fas fa-sort text-light ms-1"></i>
                </div>
            `;
            headersRow.appendChild(th);
        });
    
        // Add prediction columns with sorting
        const predTh = document.createElement('th');
        predTh.className = 'user-select-none';
        predTh.innerHTML = `
            <div class="sortable-header d-flex align-items-center justify-content-between" data-column="Predicted_Type" style="cursor: pointer;">
                <span class="fw-semibold text-white">Predicted Type</span>
                <i class="fas fa-sort text-light ms-1"></i>
            </div>
        `;
        headersRow.appendChild(predTh);
        
        const confTh = document.createElement('th');
        confTh.className = 'user-select-none';
        confTh.innerHTML = `
            <div class="sortable-header d-flex align-items-center justify-content-between" data-column="Confidence" style="cursor: pointer;">
                <span class="fw-semibold text-white">Confidence</span>
                <i class="fas fa-sort text-light ms-1"></i>
            </div>
        `;
        headersRow.appendChild(confTh);
    
        const actionTh = document.createElement('th');
        actionTh.className = 'text-center user-select-none';
        actionTh.innerHTML = '<span class="fw-semibold text-white">Actions</span>';
        headersRow.appendChild(actionTh);
    }
    
    // Add rows from paginated data
    paginatedPredictions.forEach((row, index) => {
        const actualIndex = pageSize === 'all' ? index : startIndex + index;
        const tr = document.createElement('tr');
        tr.className = 'prediction-row clickable-row';
        tr.setAttribute('data-row-index', actualIndex);
        tr.title = 'Click anywhere on this row to edit the prediction';
        
        // Regular columns with better formatting
        columns.forEach((col, colIndex) => {
            const td = document.createElement('td');
            const value = row[col] || '';
            
            // Special formatting for certain columns
            if (col.toLowerCase().includes('date')) {
                td.innerHTML = `<small class="text-muted">${value}</small>`;
            } else if (col === 'Employees') {
                td.innerHTML = `<span class="badge bg-light text-dark">${value}</span>`;
            } else if (col === 'Project') {
                td.innerHTML = `<span class="fw-medium text-primary">${value}</span>`;
            } else if (col === 'Billability Status') {
                const badgeClass = value === 'Billable' ? 'bg-success' : 'bg-warning text-dark';
                td.innerHTML = `<span class="badge ${badgeClass}">${value}</span>`;
            } else {
                td.textContent = value;
            }
            
            // Add tooltip for long text
            if (value && value.length > 30) {
                td.title = value;
                td.style.maxWidth = '200px';
                td.style.overflow = 'hidden';
                td.style.textOverflow = 'ellipsis';
                td.style.whiteSpace = 'nowrap';
            }
            
            tr.appendChild(td);
        });
        
        // Predicted type with enhanced styling
        const predTd = document.createElement('td');
        const predType = row.Predicted_Type || 'Unknown';
        const typeColorClass = getTypeColorClass(predType);
        predTd.innerHTML = `<span class="badge ${typeColorClass} px-2 py-1">${predType}</span>`;
        tr.appendChild(predTd);
        
        // Confidence with progress bar
        const confTd = document.createElement('td');
        const confidence = parseFloat(row.Confidence || 0);
        const confidencePercent = (confidence * 100).toFixed(1);
        let progressClass = 'bg-danger';
        let textClass = 'text-danger';
        
        if (confidence > 0.8) {
            progressClass = 'bg-success';
            textClass = 'text-success';
        } else if (confidence > 0.6) {
            progressClass = 'bg-warning';
            textClass = 'text-warning';
        }
        
        confTd.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress me-2" style="width: 60px; height: 8px;">
                    <div class="progress-bar ${progressClass}" style="width: ${confidencePercent}%"></div>
                </div>
                <small class="${textClass} fw-semibold">${confidencePercent}%</small>
            </div>
        `;
        tr.appendChild(confTd);
        
        // Actions with better styling
        const actionTd = document.createElement('td');
        actionTd.className = 'text-center';
        actionTd.innerHTML = `
            <div class="d-flex align-items-center justify-content-center gap-2">
                <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="event.stopPropagation(); editPrediction(${actualIndex})" title="Edit prediction">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <small class="text-muted">or click row</small>
            </div>
        `;
        tr.appendChild(actionTd);
        
        bodyTable.appendChild(tr);
    });
    
    // Show statistics and pagination
    showPredictionStats(filteredPredictions);
    updatePagination();
    updatePaginationInfo();
    
    // Add event listeners for sorting (only once)
    if (!window.sortListenersAdded) {
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                sortTable(column);
            });
        });
        window.sortListenersAdded = true;
    }
    
    // Add row click event listeners for editing
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function() {
            const rowIndex = parseInt(this.getAttribute('data-row-index'));
            editPrediction(rowIndex);
        });
    });
    
    // Hide loading and show table
    showLoading(false);
    tableDiv.classList.remove('d-none');
}

function showPredictionStats(predictions) {
    const statsDiv = document.getElementById('predictionStats');
    
    // Calculate confidence distribution
    let high = 0, medium = 0, low = 0;
    predictions.forEach(pred => {
        const conf = parseFloat(pred.Confidence || 0);
        if (conf > 0.8) high++;
        else if (conf > 0.6) medium++;
        else low++;
    });
    
    statsDiv.innerHTML = `
        <small>
            Total: ${predictions.length} | 
            <span class="confidence-high">High: ${high}</span> | 
            <span class="confidence-medium">Medium: ${medium}</span> | 
            <span class="confidence-low">Low: ${low}</span>
        </small>
    `;
}

function editPrediction(rowIndex) {
    editingRowIndex = rowIndex;
    const prediction = currentPredictions[rowIndex];
    
    // Set current prediction
    document.getElementById('currentPrediction').textContent = prediction.Predicted_Type || 'Unknown';
    
    // Populate select options from available classes
    const selectElement = document.getElementById('newPrediction');
    if (availableClasses.length === 0) {
        // Fetch classes if not already loaded
        fetch('/api/classes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                availableClasses = data.classes;
                populateClassOptions(selectElement, prediction.Predicted_Type);
            }
        })
        .catch(error => {
            console.error('Error fetching classes:', error);
            // Fallback options if fetch fails
            selectElement.innerHTML = `
                <option value="AmaliTech Internal">AmaliTech Internal</option>
                <option value="Training & Learning">Training & Learning</option>
                <option value="Reporting">Reporting</option>
                <option value="Projects">Projects</option>
                <option value="Support">Support</option>
                <option value="Governance">Governance</option>
            `;
            selectElement.value = prediction.Predicted_Type || '';
        });
    } else {
        populateClassOptions(selectElement, prediction.Predicted_Type);
    }
    
    // Show task details
    const detailsDiv = document.getElementById('taskDetails');
    detailsDiv.innerHTML = `
        <strong>Employee:</strong> ${prediction.Employees || 'N/A'}<br>
        <strong>Task:</strong> ${prediction['Task Name'] || 'N/A'}<br>
        <strong>Category:</strong> ${prediction.Category || 'N/A'}<br>
        <strong>Confidence:</strong> ${(parseFloat(prediction.Confidence || 0) * 100).toFixed(1)}%
    `;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

// Save edit handler
document.getElementById('saveEditBtn').addEventListener('click', function() {
    const newType = document.getElementById('newPrediction').value;
    
    if (!newType || editingRowIndex === null) return;
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    fetch('/update_prediction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: serverFilename,
            row_index: editingRowIndex,
            new_type: newType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update local data
            currentPredictions[editingRowIndex].Predicted_Type = newType;
            
            // Refresh display
            showPredictions(currentPredictions);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = 'Save Changes';
    });
});

// Helper function to populate class options
function populateClassOptions(selectElement, currentValue) {
    selectElement.innerHTML = '';
    availableClasses.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        if (className === currentValue) {
            option.selected = true;
        }
        selectElement.appendChild(option);
    });
}

// Helper function to get color class for prediction types
function getTypeColorClass(type) {
    const typeColors = {
        'AmaliTech Internal': 'bg-info text-white',
        'Training & Learning': 'bg-success text-white',
        'Reporting': 'bg-primary text-white',
        'Projects': 'bg-warning text-dark',
        'Support': 'bg-secondary text-white',
        'Governance': 'bg-dark text-white',
        'Holiday': 'bg-light text-dark',
        'Leave': 'bg-light text-dark',
        'Team admin': 'bg-info text-white'
    };
    return typeColors[type] || 'bg-primary text-white';
}

// Loading overlay functions
function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        if (show) {
            overlay.classList.remove('d-none');
        } else {
            overlay.classList.add('d-none');
        }
    }
}

// Pagination functions
function updatePagination() {
    const paginationList = document.getElementById('paginationList');
    if (!paginationList) return;
    
    paginationList.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">Previous</a>`;
    paginationList.appendChild(prevLi);
    
    // Calculate page range to show
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    // Adjust if we're near the beginning or end
    if (endPage - startPage < 4) {
        if (startPage === 1) {
            endPage = Math.min(totalPages, startPage + 4);
        } else {
            startPage = Math.max(1, endPage - 4);
        }
    }
    
    // First page and ellipsis if needed
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(1); return false;">1</a>`;
        paginationList.appendChild(firstLi);
        
        if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            paginationList.appendChild(ellipsisLi);
        }
    }
    
    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
        paginationList.appendChild(pageLi);
    }
    
    // Last page and ellipsis if needed
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            paginationList.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a>`;
        paginationList.appendChild(lastLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">Next</a>`;
    paginationList.appendChild(nextLi);
}

function updatePaginationInfo() {
    const pageInfo = document.getElementById('pageInfo');
    const paginationInfo = document.getElementById('paginationInfo');
    
    if (pageSize === 'all') {
        if (pageInfo) pageInfo.textContent = `Showing all ${filteredPredictions.length} records`;
        if (paginationInfo) paginationInfo.textContent = `${filteredPredictions.length} total`;
    } else {
        const startRecord = (currentPage - 1) * parseInt(pageSize) + 1;
        const endRecord = Math.min(currentPage * parseInt(pageSize), filteredPredictions.length);
        
        if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${startRecord}-${endRecord} of ${filteredPredictions.length})`;
        if (paginationInfo) paginationInfo.textContent = `${filteredPredictions.length} records`;
    }
}

function goToPage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
        currentPage = page;
        showPredictions(currentPredictions);
    }
}

// Enhanced sorting functionality with pagination
function sortTable(column) {
    if (currentSortColumn === column) {
        // Toggle direction if same column
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // New column, default to ascending
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // Update sort icons
    document.querySelectorAll('.sortable-header i').forEach(icon => {
        icon.className = 'fas fa-sort text-light';
    });
    
    const currentHeader = document.querySelector(`[data-column="${column}"] i`);
    if (currentHeader) {
        if (currentSortDirection === 'asc') {
            currentHeader.className = 'fas fa-sort-up text-warning';
        } else {
            currentHeader.className = 'fas fa-sort-down text-warning';
        }
    }
    
    // Sort the filtered data (not the current page)
    filteredPredictions.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // Handle numeric columns
        if (column === 'Confidence') {
            aVal = parseFloat(aVal) || 0;
            bVal = parseFloat(bVal) || 0;
        } else {
            // Handle text columns
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
        }
        
        if (currentSortDirection === 'asc') {
            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        } else {
            return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
        }
    });
    
    // Reset to first page after sorting
    currentPage = 1;
    showPredictions(currentPredictions);
}

// Enhanced Search/Filter functionality with pagination
document.addEventListener('DOMContentLoaded', function() {
    // Add functionality when DOM is ready
    setTimeout(() => {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterTable(searchTerm);
            });
        }
        
        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                resetTable();
            });
        }
        
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                showPredictions(currentPredictions, true);
            });
        }
        
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                pageSize = this.value;
                currentPage = 1; // Reset to first page
                showPredictions(currentPredictions);
            });
        }
        
        const jumpToPage = document.getElementById('jumpToPage');
        if (jumpToPage) {
            jumpToPage.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const page = parseInt(this.value);
                    if (page >= 1 && page <= totalPages) {
                        goToPage(page);
                        this.value = '';
                    }
                }
            });
        }
    }, 100);
});

function filterTable(searchTerm) {
    if (!originalPredictions) return;
    
    if (searchTerm === '') {
        filteredPredictions = [...originalPredictions];
    } else {
        filteredPredictions = originalPredictions.filter(row => {
            return Object.values(row).some(value => 
                (value || '').toString().toLowerCase().includes(searchTerm)
            );
        });
    }
    
    // Reset to first page when filtering
    currentPage = 1;
    
    // Reapply current sorting if any
    if (currentSortColumn) {
        const tempSortCol = currentSortColumn;
        const tempSortDir = currentSortDirection;
        currentSortColumn = null; // Reset to trigger fresh sort
        currentSortDirection = tempSortDir === 'asc' ? 'desc' : 'asc'; // Will be toggled back
        sortTable(tempSortCol);
    } else {
        showPredictions(currentPredictions);
    }
}

function resetTable() {
    if (!originalPredictions) return;
    
    // Reset search
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';
    
    // Reset page size
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (pageSizeSelect) pageSizeSelect.value = '50';
    pageSize = 50;
    
    // Reset pagination
    currentPage = 1;
    
    // Reset sorting
    currentSortColumn = null;
    currentSortDirection = 'asc';
    document.querySelectorAll('.sortable-header i').forEach(icon => {
        icon.className = 'fas fa-sort text-light';
    });
    
    // Reset data
    filteredPredictions = [...originalPredictions];
    showPredictions(currentPredictions, true);
}
</script>
{% endblock %}